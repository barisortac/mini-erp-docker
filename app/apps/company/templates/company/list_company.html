{% extends 'layouts/base.html' %}
{% load i18n %}
{% load static %}

{% block title %} Tables {% endblock title %}

{% block content %}

    <!-- Main content -->
    <div class="main-content" id="panel">
        <!-- Topnav -->
        <!-- Page content -->
        <div class="container-fluid mt-2">
            <!-- Table -->

            <div class="row">
                <div class="col">
                    <div class="card">
                        <!-- Card header -->
                        <div class="card-header">
                            <h2 class="mb-0">{% trans "Companies" %}</h2>
                        </div>

{#                            FILTERS#}
                        <div class="card-header form-group">
                            <div class="row">
                                <div class="form-group col-md-2">
                                    <label for="city">Şehir</label>
                                    <select class="form-control" id="city" name="city">
                                    </select>
                                </div>
                            </div>
                        </div>
{#                            FILTERS#}

                        <div class="table-responsive py-4">
                            <table class="table table-flush"
                                   id="datatable-basic">
                                <thead class="thead-light">
                                <tr>
                                    <th>ID</th>
                                    <th>Değiştir / Sil</th>
                                    <th>Adı</th>
                                    <th>Cari Kodu</th>
                                    <th>Vergi Dairesi</th>
                                    <th>Vergi No</th>
                                    <th>Telefon</th>
                                    <th>Ödeme Şekli</th>
                                    <th>Şehir</th>

{#                                    <th>Düzenle</th>#}
{#                                    <th>Sil</th>#}
                                </tr>
                                </thead>
{#                                <tbody></tbody>#}
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

{#    {% for c in company_list %}#}
{#    <div class="text-center">#}
{#      <!-- Read book buttons -->#}
{#      <button type="button" id="read-book" class="bs-modal btn btn-sm btn-primary" data-form-url="{% url 'read-company' c.pk %}">#}
{#        <span class="fa fa-eye">{{ c.name }}</span>#}
{#      </button>#}
{#      <!-- Update book buttons -->#}
{#      <button type="button" id="update-booksdsd" class="bs-modal btn btn-sm btn-primary" data-form-url="{% url 'update-company' c.pk %}">#}
{#        <span class="fa fa-pencil">Güncelle {{ c.name }}</span>#}
{#      </button>#}
{#      <!-- Delete book buttons -->#}
{#      <button type="button" id="delete-book" class="bs-modal btn btn-sm btn-danger" data-form-url="{% url 'delete-company' c.pk %}">#}
{#        <span class="fa fa-trash">{{ c.name }}</span>#}
{#      </button>#}
{#    </div>#}
{#    {% endfor %}#}
{% endblock %}

{% block javascripts %}

<script>
    $(document).ready(function() {
        var table = $('#datatable-basic').DataTable({
            dom: 'lBfrtip',
            language: {
                paginate: {
                    previous: "<i class='fas fa-angle-left'>",
                    next: "<i class='fas fa-angle-right'>"
                }
            },
            processing: true,
            serverSide: true,
            scrollX: true,
            responsive: true,
            minLength: 2,
            order: [],
            buttons: [
                {
                    className: 'create-company btn-success',
                    text: 'Yeni Firma',
                },
                {
                    className:"filter btn-warning",
                    text: "Filtrele",
                    tag: "a"
                },
                "copy", "csv",
            ],
            ajax: {
                url: "{% url 'company-list-json' %}",
                type: "GET",
                dataSrc: "data",
                processing: true,
                complete: function (data) {
                    populateButtonModals();
                },
            },

            // we need ID column for edit & delete modals (TODO: investigate it)
            columnDefs: [
                {
                    "targets": [ 0 ],
                    "visible": false,
                    "searchable": false
                },
            ],

            columns: [
                { data: "id" },
                {
                    data: null,
                    orderable: false,
                    render: function ( data, type, row ) {
                    return '<button type="button" id="update-company-inside" class="bs-modal btn btn-sm btn-primary" data-toggle="modal" data-form-url="{% url "update-company" "0" %}"><span>Değiştir</span></button>'.replace('0', row['id']) +
                    '<button type="button" id="delete-company-inside" class="bs-modal btn btn-sm btn-danger" data-toggle="modal" data-form-url="{% url "delete-company" "0" %}"><span>Sil</span></button>'.replace('0', row['id']);
                    }
                },
                { data: "name" },
                { data: "code" },
                { data: "tax_office" },
                { data: "tax_number" },
                { data: "phone" },
                { data: "payment_type" },
                { data: "city" },
            ]
        });

        {#$('.dataTables_length select').select2({minimumResultsForSearch: Infinity, width: ''});#}


        $(".create-company").modalForm({
            formURL: "{% url 'create-company' %}",
            modalID: "#create-modal"
        });

        //$("#create-tax-office").modalForm({
        //    formURL: "{% url 'create-tax-office' %}",
        //    modalID: "#create-inside-modal",
        //});


        function populateButtonModals () {
            // Todo: event listener didn't work at first time, so after ajax complete,
            //  this function handles modals, not sure if its healthy
            $("#update-company-inside, #delete-company-inside").each(function () {
                $(this).modalForm({
                    formURL: $(this).data('form-url')
                });
            });
        }

        $('#city').select2({
            allowClear: true,
            placeholder: "Şehir..",
            ajax: {
                url: "{% url 'city-autocomplete' %}",
                dataType: "json",
            }
        });

        $('.filter').click(function () {
            let city = $('#city').val();
            table.columns(7).search(city);
            table.draw();
        });
    });

</script>
{% endblock %}